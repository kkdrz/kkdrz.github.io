{"componentChunkName":"component---src-templates-blog-post-js","path":"/sip-proxy-with-netty-and-sipstack/","result":{"data":{"site":{"siteMetadata":{"title":"Konrad Drozd: Blog"}},"markdownRemark":{"id":"c6e0574b-e7d1-5aa1-9adb-1f84dbd11404","excerpt":"In this post I will show you how to make a simple proxy server for SIP protocol.\nRecently I spent some time with netty and decided to create some simpleâ€¦","html":"<p>In this post I will show you how to make a simple proxy server for SIP protocol.\nRecently I spent some time with <a href=\"https://netty.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">netty</a> and decided to create some simple application to solidify my knowledge.\nI will use the <a href=\"https://www.sipstack.io/getstarted/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sipstack</a> library as a support for the SIP protocol (decoding, encodingâ€¦).\nActually, the protocol that Iâ€™ve used doesnâ€™t matter so much, but web is full of HTTP proxies tutorials and I wanted to bring something new.</p>\n<p>As always, you will find the final code <a href=\"github\">on my github</a>.</p>\n<h2 id=\"but-why-sip-what-is-it-anyway\" style=\"position:relative;\"><a href=\"#but-why-sip-what-is-it-anyway\" aria-label=\"but why sip what is it anyway permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But why SIP? What is it anyway?</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/Session_Initiation_Protocol\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SIP</a> stands for <em>Session Initiation Protocol</em>.\nIn simple words, this protocol is used to set up sessions between clients,\nfor example in IP telephony (<a href=\"https://en.wikipedia.org/wiki/Voice_over_IP\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Voice over Internet Protocol</a>).\nThis is the protocol that we use when writing <a href=\"https://en.wikipedia.org/wiki/Value-added_service\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">value-added-services</a> in my current job.\nAn extremely simplified diagram of how this protocol works looks like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/715a3/sip_flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4y31Ty47TQBD0f/IBXLnzAVz5mOUMCHHZA6wSJNAui5M4kZ04fnvsedguVJ3MrkPQjtTqdrunprp6JpimCTRgwjA47NMjfO6UBx4eQ/xZbyT2OWOs1PqczweYLW1GfLxdwjn7lLPW4tXrN3j77r18j+eNedXg8+3iGtCpCLoOoZsQpo2w3yfywzkHY4zEh8MBrVLzs2GtQ3rMpLNpGs82IbBtiL56QFfewzaPMH0txXVdoyxLYdj3PcZxlEOYG4YBzlqcSV2swNW/oLIF+mIJV9/D6Ab/1pFp13VQSiHPc/Fdp9EUG+hiiS7/gS5fQFe/EdjiO8r4C+rkK2zxDVW+hbEOx2OK3W4n7AjQtq2AhWEoXpsB7fEnqugG+foDis0NmvjT5VDITKlOGFG3OI6FGUGZo2+aRjxlYTeDyWH7DFZnGEyBYH5FaNSMehGIxpgAforUz092/J+G85HTeyBvZHbSbK5hi6qq5FumPA7PU55fVj/FLMtkIy2KIvFFUQgAa1lH67W5YHcFyHa01lLMmOySJMF2u8VqtRJNyUzrHlpbtGUkt0Nld7Bqd/1SuNgadSSjNE1FQx5CcB5ClvyvjYHpcli1hW7WcH36DDjX0OvFtgnImDIQlFfH506HuJdblsmN49XkmJPXcX6OjMny9Oanp4GQ4V/VuD06A+5ZcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Simple SIP flow\"\n        title=\"Open image\"\n        src=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/f058b/sip_flow.png\"\n        srcset=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/c26ae/sip_flow.png 158w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/6bdcf/sip_flow.png 315w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/f058b/sip_flow.png 630w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/715a3/sip_flow.png 830w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>I chose this protocol in order to expand my competences.\nPerhaps, in addition to learning, this playground will be useful for something at work :)</p>\n<h2 id=\"objective\" style=\"position:relative;\"><a href=\"#objective\" aria-label=\"objective permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Objective</h2>\n<p>The application will work exactly as shown in the diagram above.\nMessages will be sent without making any changes to them. This will be a so-called <a href=\"https://www.tutorialspoint.com/session_initiation_protocol/session_initiation_protocol_proxies_and_routing.htm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">stateless proxy</a>.</p>\n<blockquote>\n<p>Stateless proxies forget about the SIP request once it has been forwarded. This kind of server does not store any information of the call or transaction.</p>\n</blockquote>\n<p>Information about who is the addressee of the message will be included in the <code class=\"language-text\">Route</code> header.</p>\n<p><strong>Technologies used:</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"https://netty.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Netty</a></td>\n</tr>\n<tr>\n<td><a href=\"https://www.sipstack.io/getstarted/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SipStack</a></td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/SIPp/sipp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SIPp</a> (for functional testing)</td>\n</tr>\n<tr>\n<td><a href=\"https://kotlinlang.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kotlin</a> (as part of learning ðŸ˜Š)</td>\n</tr>\n<tr>\n<td><a href=\"https://gradle.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Gradle</a></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"project-setup\" style=\"position:relative;\"><a href=\"#project-setup\" aria-label=\"project setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Project setup</h2>\n<p>I started from generating a <em>hello-world</em> template using IntelliJ and added the necessary dependencies:</p>\n<div class=\"gatsby-highlight\" data-language=\"gradle\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-gradle line-numbers\"><code class=\"language-gradle\">dependencies {\n//    SIP support\n    implementation(&quot;io.sipstack:sipstack-netty-codec-sip:0.1.1&quot;)\n    \n//    logging\n    implementation(&quot;org.slf4j:slf4j-api:1.7.30&quot;)\n    implementation(&quot;ch.qos.logback:logback-classic:1.2.3&quot;)\n    implementation(&quot;ch.qos.logback:logback-core:1.2.3&quot;)\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"set-up-netty-server\" style=\"position:relative;\"><a href=\"#set-up-netty-server\" aria-label=\"set up netty server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Set up netty server</h2>\n<p>Then I created a main class <code class=\"language-text\">ProxyApp</code> that runs the netty server.</p>\n<p>In the code I took the following nomenclature:</p>\n<ul>\n<li><code class=\"language-text\">upstream</code> - this is where the messages originally come (Bob)</li>\n<li><code class=\"language-text\">downstream</code> - this is where the messages are proxied (Alice)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> pl<span class=\"token punctuation\">.</span>kdrozd<span class=\"token punctuation\">.</span>examples<span class=\"token punctuation\">.</span>sipproxy\n\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>bootstrap<span class=\"token punctuation\">.</span>ServerBootstrap\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>Channel\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>ChannelInitializer\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>NioEventLoopGroup\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>socket<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>NioServerSocketChannel\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageEncoder\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageStreamDecoder\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span>InetSocketAddress\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">ProxyApp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> hostname<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> port<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> upstreamChannel<span class=\"token operator\">:</span> Channel<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> workGroup <span class=\"token operator\">=</span> <span class=\"token function\">NioEventLoopGroup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> bossGroup <span class=\"token operator\">=</span> <span class=\"token function\">NioEventLoopGroup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> b <span class=\"token operator\">=</span> <span class=\"token function\">ServerBootstrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        b<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span>bossGroup<span class=\"token punctuation\">,</span> workGroup<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span>NioServerSocketChannel<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">childHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ChannelInitializer<span class=\"token operator\">&lt;</span>Channel<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">initChannel</span><span class=\"token punctuation\">(</span>ch<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">with</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">.</span><span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"decoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageStreamDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"encoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> socketAddress <span class=\"token operator\">=</span> <span class=\"token function\">InetSocketAddress</span><span class=\"token punctuation\">(</span>hostname<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> f <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>socketAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        upstreamChannel <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>isActive <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            upstreamChannel<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This class is not very interesting and looks like most of the other classes that bootstrap netty.\nWe use <code class=\"language-text\">NioServerSocketChannel</code>, because we want to use <code class=\"language-text\">TCP</code> protocol.\nIn the case of <code class=\"language-text\">UDP</code>, we would use <code class=\"language-text\">NioDatagramChannel</code>.\nIf you need more explanation of whatâ€™s going on here, check out <a href=\"https://netty.io/wiki/user-guide-for-4.x.html#writing-a-discard-server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the netty documentation</a>.</p>\n<p>The most interesting part is setting up the message decoder/encoder:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\">b<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span>bossGroup<span class=\"token punctuation\">,</span> workGroup<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span>NioServerSocketChannel<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">childHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ChannelInitializer<span class=\"token operator\">&lt;</span>Channel<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">initChannel</span><span class=\"token punctuation\">(</span>ch<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">with</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">.</span><span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"decoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageStreamDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"encoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">SipMessageStreamDecoder</code> is the decoder for the incoming data. It decodes bytes to <code class=\"language-text\">SipMessageEvent</code> and works for stream based protocols (TCP).\nIf you want to use datagram based protocols (UDP), there is an alternative: <code class=\"language-text\">SipMessageDatagramDecoder</code>.</p>\n<p><code class=\"language-text\">SipMessageEncoder</code> encodes <code class=\"language-text\">SipMessageEvent</code> back to bytes. It is used for both TCP and UDP.</p>\n<p>With a simple <code class=\"language-text\">main</code> method we can run the service:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> pl<span class=\"token punctuation\">.</span>kdrozd<span class=\"token punctuation\">.</span>examples<span class=\"token punctuation\">.</span>sipproxy\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> app <span class=\"token operator\">=</span> <span class=\"token function\">ProxyApp</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"127.0.0.1\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token number\">5060</span><span class=\"token punctuation\">)</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"create-handlers\" style=\"position:relative;\"><a href=\"#create-handlers\" aria-label=\"create handlers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create handlers</h2>\n<p>After startup, our server is able to accept messages,\nbut we havenâ€™t added any message handler to the pipeline, so it doesnâ€™t do anything with them.</p>\n<p>Below is the <strong><code class=\"language-text\">ProxyUpstreamHandler</code></strong> implementation.\nThis is the handler responsible for receiving messages from <code class=\"language-text\">upstream</code>, creating connection with <code class=\"language-text\">downstream</code> and proxying the messages.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> pl<span class=\"token punctuation\">.</span>kdrozd<span class=\"token punctuation\">.</span>examples<span class=\"token punctuation\">.</span>sipproxy\n\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>bootstrap<span class=\"token punctuation\">.</span>Bootstrap\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">.</span>Unpooled\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span>\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>socket<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>NioSocketChannel\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>pkts<span class=\"token punctuation\">.</span>packet<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessage\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>pkts<span class=\"token punctuation\">.</span>packet<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">.</span>SipURI\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageEncoder\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageEvent\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageStreamDecoder\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory\n\n<span class=\"token keyword\">class</span> ProxyUpstreamHandler <span class=\"token operator\">:</span> SimpleChannelInboundHandler<span class=\"token operator\">&lt;</span>SipMessageEvent<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 1</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> downstreamChannel<span class=\"token operator\">:</span> Channel<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">channelRead0</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 2</span>\n        ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token punctuation\">,</span>\n        event<span class=\"token operator\">:</span> SipMessageEvent\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> msg <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>message\n        <span class=\"token keyword\">val</span> upstreamChannel<span class=\"token operator\">:</span> Channel <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> f<span class=\"token operator\">:</span> ChannelFuture <span class=\"token operator\">=</span> <span class=\"token function\">connectWithDownstream</span><span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 3</span>\n\n        f<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>ChannelFutureListener <span class=\"token punctuation\">{</span> connectionCompleteFuture<span class=\"token operator\">:</span> ChannelFuture <span class=\"token operator\">-></span> <span class=\"token comment\">// 4</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>connectionCompleteFuture<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            downstreamChannel <span class=\"token operator\">=</span> connectionCompleteFuture<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">proxyMessageToDownstream</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">connectWithDownstream</span><span class=\"token punctuation\">(</span>\n        upstreamChannel<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">,</span>\n        msg<span class=\"token operator\">:</span> SipMessage\n    <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ChannelFuture <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> b <span class=\"token operator\">=</span> <span class=\"token function\">Bootstrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        b<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token punctuation\">.</span><span class=\"token function\">eventLoop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span>NioSocketChannel<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ChannelInitializer<span class=\"token operator\">&lt;</span>Channel<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">initChannel</span><span class=\"token punctuation\">(</span>ch<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">with</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">.</span><span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"decoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageStreamDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"encoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"handler\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">ProxyDownstreamHandler</span><span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 5</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> routeHeader <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>routeHeader<span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">.</span>uri <span class=\"token keyword\">as</span> SipURI <span class=\"token comment\">// 6</span>\n        <span class=\"token keyword\">return</span> b<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>routeHeader<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routeHeader<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 7</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">proxyMessageToDownstream</span><span class=\"token punctuation\">(</span>ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">:</span> SipMessage<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        downstreamChannel<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeAndFlush</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>\n            ChannelFutureListener <span class=\"token punctuation\">{</span> messageProxiedFuture<span class=\"token operator\">:</span> ChannelFuture <span class=\"token operator\">-></span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>messageProxiedFuture<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>messageProxiedFuture<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">exceptionCaught</span><span class=\"token punctuation\">(</span>ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token punctuation\">,</span> cause<span class=\"token operator\">:</span> Throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 8</span>\n        cause<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>ch<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">.</span>isActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                ch<span class=\"token punctuation\">.</span><span class=\"token function\">writeAndFlush</span><span class=\"token punctuation\">(</span>Unpooled<span class=\"token punctuation\">.</span>EMPTY_BUFFER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>ChannelFutureListener<span class=\"token punctuation\">.</span>CLOSE<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This class is a bit more complicated, so I will try to describe the most important parts:</p>\n<ol>\n<li>Since <code class=\"language-text\">SipMessageStreamDecoder</code> decodes bytes to <code class=\"language-text\">SipMessageEvent</code> we need our handler to operate with this class.</li>\n</ol>\n<p>Thatâ€™s why we extend the <code class=\"language-text\">SimpleChannelInboundHandler&lt;SipMessageEvent></code> class.</p>\n<ol start=\"2\">\n<li><code class=\"language-text\">channelRead0</code> method is called whenever new data is received from client.</li>\n</ol>\n<p>Thanks to the fact that we extend the <code class=\"language-text\">SimpleChannelInboundHandler&lt;SipMessageEvent></code> class, as an input we get a decoded <code class=\"language-text\">SipMessageEvent</code>.</p>\n<ol start=\"3\">\n<li>\n<p>We set up a connection between proxy server and the destination. The setup is very similar to the one from <code class=\"language-text\">ProxyApp</code> class.</p>\n</li>\n<li>\n<p>As soon as the connection is established, we want to send a message to the destination,</p>\n</li>\n</ol>\n<p>that is why we set up a listener. If anything goes wrong with the connection or message transfer, we just close the channel.</p>\n<ol start=\"5\">\n<li>\n<p><code class=\"language-text\">ProxyDownstreamHandler</code> is a handler for messages that come from the destination. I will describe it later.</p>\n</li>\n<li>\n<p>Here, we try to read the destination address from <code class=\"language-text\">Route</code> header.</p>\n</li>\n</ol>\n<p>I could use some security in case this header is not defined, but I donâ€™t want to complicate the code.</p>\n<ol start=\"7\">\n<li>\n<p>Here, the connection is started.</p>\n</li>\n<li>\n<p>If we get an exception along the way, we also just close the channel.</p>\n</li>\n</ol>\n<p><strong><code class=\"language-text\">ProxyDownstreamHandler</code></strong> is much simplier.\nAny message that arrives is simply sent to the upstream channel.\nIf the <code class=\"language-text\">server &lt;-> downstream</code> channel is deactivated, we close the <code class=\"language-text\">server &lt;-> upstream</code> channel as well.\nAs before, in case of any failure/exception, we close the channel.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> pl<span class=\"token punctuation\">.</span>kdrozd<span class=\"token punctuation\">.</span>examples<span class=\"token punctuation\">.</span>sipproxy\n\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span>\n<span class=\"token keyword\">import</span> io<span class=\"token punctuation\">.</span>sipstack<span class=\"token punctuation\">.</span>netty<span class=\"token punctuation\">.</span>codec<span class=\"token punctuation\">.</span>sip<span class=\"token punctuation\">.</span>SipMessageEvent\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory\n<span class=\"token keyword\">import</span> pl<span class=\"token punctuation\">.</span>kdrozd<span class=\"token punctuation\">.</span>examples<span class=\"token punctuation\">.</span>sipproxy<span class=\"token punctuation\">.</span>ProxyUpstreamHandler<span class=\"token punctuation\">.</span>Companion<span class=\"token punctuation\">.</span>closeAndFlush\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">ProxyDownstreamHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> upstreamChannel<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> SimpleChannelInboundHandler<span class=\"token operator\">&lt;</span>SipMessageEvent<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">channelRead0</span><span class=\"token punctuation\">(</span>ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token punctuation\">,</span> event<span class=\"token operator\">:</span> SipMessageEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> msg <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>message\n        \n        upstreamChannel<span class=\"token punctuation\">.</span><span class=\"token function\">writeAndFlush</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span>ChannelFutureListener <span class=\"token punctuation\">{</span> future<span class=\"token operator\">:</span> ChannelFuture <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                ctx<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">channelInactive</span><span class=\"token punctuation\">(</span>ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>upstreamChannel<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">exceptionCaught</span><span class=\"token punctuation\">(</span>ctx<span class=\"token operator\">:</span> ChannelHandlerContext<span class=\"token punctuation\">,</span> cause<span class=\"token operator\">:</span> Throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cause<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">closeAndFlush</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>These are all the elements we need for our proxy to work.\nThe last step is to add the <code class=\"language-text\">ProxyUpstreamHandler</code> to the pipeline in the <code class=\"language-text\">ProxyApp</code> class:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\">b<span class=\"token punctuation\">.</span><span class=\"token function\">group</span><span class=\"token punctuation\">(</span>bossGroup<span class=\"token punctuation\">,</span> workGroup<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span>NioServerSocketChannel<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">childHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> ChannelInitializer<span class=\"token operator\">&lt;</span>Channel<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">initChannel</span><span class=\"token punctuation\">(</span>ch<span class=\"token operator\">:</span> Channel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">with</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">.</span><span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"decoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageStreamDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"encoder\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">SipMessageEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">addLast</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"handler\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token function\">ProxyUpstreamHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// &lt;----</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"create-a-test\" style=\"position:relative;\"><a href=\"#create-a-test\" aria-label=\"create a test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create a test</h2>\n<p>To test the proxy I will use <a href=\"https://github.com/SIPp/sipp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the SIPp</a> application.\nIt allows to create <code class=\"language-text\">XML</code> scenarios and send <code class=\"language-text\">SIP</code> messages.\nIâ€™d say it is <a href=\"https://www.postman.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the Postman</a> equivalent for SIP protocol.</p>\n<p>The test case will look exactly the same as the connection between Bob and Alice at the beginning of the post:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/715a3/sip_flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4y31Ty47TQBD0f/IBXLnzAVz5mOUMCHHZA6wSJNAui5M4kZ04fnvsedguVJ3MrkPQjtTqdrunprp6JpimCTRgwjA47NMjfO6UBx4eQ/xZbyT2OWOs1PqczweYLW1GfLxdwjn7lLPW4tXrN3j77r18j+eNedXg8+3iGtCpCLoOoZsQpo2w3yfywzkHY4zEh8MBrVLzs2GtQ3rMpLNpGs82IbBtiL56QFfewzaPMH0txXVdoyxLYdj3PcZxlEOYG4YBzlqcSV2swNW/oLIF+mIJV9/D6Ab/1pFp13VQSiHPc/Fdp9EUG+hiiS7/gS5fQFe/EdjiO8r4C+rkK2zxDVW+hbEOx2OK3W4n7AjQtq2AhWEoXpsB7fEnqugG+foDis0NmvjT5VDITKlOGFG3OI6FGUGZo2+aRjxlYTeDyWH7DFZnGEyBYH5FaNSMehGIxpgAforUz092/J+G85HTeyBvZHbSbK5hi6qq5FumPA7PU55fVj/FLMtkIy2KIvFFUQgAa1lH67W5YHcFyHa01lLMmOySJMF2u8VqtRJNyUzrHlpbtGUkt0Nld7Bqd/1SuNgadSSjNE1FQx5CcB5ClvyvjYHpcli1hW7WcH36DDjX0OvFtgnImDIQlFfH506HuJdblsmN49XkmJPXcX6OjMny9Oanp4GQ4V/VuD06A+5ZcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Simple SIP flow\"\n        title=\"Open image\"\n        src=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/f058b/sip_flow.png\"\n        srcset=\"/static/fc64c37a9c81ce4c5b13a70179bbaff8/c26ae/sip_flow.png 158w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/6bdcf/sip_flow.png 315w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/f058b/sip_flow.png 630w,\n/static/fc64c37a9c81ce4c5b13a70179bbaff8/715a3/sip_flow.png 830w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>For this purpose, I defined the two scenarios:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?></span>\n<span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">scenario</span> <span class=\"token name\">SYSTEM</span> <span class=\"token string\">\"sipp.dtd\"</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scenario</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Bob<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span> <span class=\"token attr-name\">retrans</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n\n      INVITE sip:[service]@[remote_ip]:[remote_port] SIP/2.0\n      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]\n      From: sipp &lt;sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag00[call_number]\n      To: [service] &lt;sip:[service]@[remote_ip]:[remote_port]>\n      Call-ID: [call_id]\n      CSeq: 1 INVITE\n      Route: &lt;sip:127.0.0.1:[alices_port];transport=[transport];lr>\n      Contact: sip:sipp@[local_ip]:[local_port]\n      Max-Forwards: 70\n      Content-Type: application/sdp\n      Content-Length: 0\n\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">response</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>180<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">optional</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">response</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>200<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rtd</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n      ACK sip:[service]@[remote_ip]:[remote_port] SIP/2.0\n      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]\n      From: sipp &lt;sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag00[call_number]\n      To: [service] &lt;sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]\n      Route: &lt;sip:127.0.0.1:[alices_port];transport=[transport];lr>\n      Call-ID: [call_id]\n      CSeq: 1 ACK\n      Contact: sip:sipp@[local_ip]:[local_port]\n      Max-Forwards: 70\n      Content-Length: 0\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">request</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>BYE<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n\n      SIP/2.0 200 OK\n      [last_Via:]\n      [last_From:]\n      [last_To:]\n      [last_Call-ID:]\n      [last_CSeq:]\n      Route: &lt;sip:127.0.0.1:[alices_port];transport=[transport];lr>\n      Contact: &lt;sip:[local_ip]:[local_port];transport=[transport]>\n      Content-Length: 0\n\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scenario</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?></span>\n<span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">scenario</span> <span class=\"token name\">SYSTEM</span> <span class=\"token string\">\"sipp.dtd\"</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scenario</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Alice<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                                      -->\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">request</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>INVITE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crlf</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n\n      SIP/2.0 180 Ringing\n      [last_Via:]\n      [last_From:]\n      [last_To:];tag=[pid]SIPpTag01[call_number]\n      [last_Call-ID:]\n      [last_CSeq:]\n      Contact: &lt;sip:[local_ip]:[local_port];transport=[transport]>\n      Content-Length: 0\n\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pause</span> <span class=\"token attr-name\">milliseconds</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3000<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span> <span class=\"token attr-name\">retrans</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n\n      SIP/2.0 200 OK\n      [last_Via:]\n      [last_From:]\n      [last_To:];tag=[pid]SIPpTag01[call_number]\n      [last_Call-ID:]\n      [last_CSeq:]\n      Contact: &lt;sip:[local_ip]:[local_port];transport=[transport]>\n      Content-Type: application/sdp\n      Content-Length: 0\n\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">request</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ACK<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">rtd</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">crlf</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pause</span> <span class=\"token attr-name\">milliseconds</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3000<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>send</span> <span class=\"token attr-name\">retrans</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token cdata\">&lt;![CDATA[\n      BYE sip:[service]@[remote_ip]:[remote_port] SIP/2.0\n      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]\n      From: sipp &lt;sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag00[call_number]\n      To: [service] &lt;sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]\n      Call-ID: [call_id]\n      CSeq: 2 BYE\n      Contact: sip:sipp@[local_ip]:[local_port]\n      Max-Forwards: 70\n      Subject: Performance Test\n      Content-Length: 0\n    ]]></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>send</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>recv</span> <span class=\"token attr-name\">response</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>200<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crlf</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>recv</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scenario</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>and launch script:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token comment\"># Kill any existing sipp processes</span>\n<span class=\"token function\">pkill</span> sipp\n\n<span class=\"token comment\"># Start Alice's agent in background</span>\nsipp <span class=\"token number\">127.0</span>.0.1:5060 -sf alice.xml -t t1 -m <span class=\"token number\">1</span> -bg -trace_screen\n\n<span class=\"token comment\"># Get the Alice's agent port (quite naive, I do not recommend using it in real tests)</span>\n<span class=\"token assign-left variable\">ALICES_PORT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sudo</span>  <span class=\"token function\">netstat</span> -ltnp <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"/sipp\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{ print $4 }'</span> <span class=\"token operator\">|</span>  <span class=\"token function\">grep</span> -o <span class=\"token string\">\"[^:]*$\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># Start Bob's agent</span>\nsipp <span class=\"token number\">127.0</span>.0.1:5060 -sf bob.xml -t t1 -m <span class=\"token number\">1</span> -key alices_port <span class=\"token variable\">${ALICES_PORT}</span> -trace_screen</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Short description of <code class=\"language-text\">sipp</code> parameters:</p>\n<p>||\n|-----|-----|\n|<code class=\"language-text\">-sf</code>|scenario file|\n|<code class=\"language-text\">-t t1</code>| use TCP|\n|<code class=\"language-text\">-m1</code>| perform 1 call|\n|<code class=\"language-text\">-key alices_port ${ALICES_PORT}</code> | set a key that will be available in the <code class=\"language-text\">XML</code> scenario as <code class=\"language-text\">[alices_port]</code>|\n| -trace_screen | generate a file with agentâ€™s messages flow |</p>\n<h2 id=\"run-the-test\" style=\"position:relative;\"><a href=\"#run-the-test\" aria-label=\"run the test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run the test</h2>\n<p>You need to install the <code class=\"language-text\">SIPp</code> application to run the test.\nAnd if you did, just:</p>\n<ol>\n<li>Run the proxy service from <code class=\"language-text\">main</code> method.</li>\n<li>Run the test shell script</li>\n</ol>\n<p>Both agents should generate <code class=\"language-text\">*_screen.log</code> files with output similiar to this one:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">------------------------------ Scenario Screen -------- [1-9]: Change Screen --\n  Call rate (length)   Port   Total-time  Total-calls  Remote-host\n  10.0(0 ms)/1.000s   5062       6.23 s            1  127.0.0.1:5060(TCP)\n\n  Call limit 1 hit, 0.0 s period          0 ms scheduler resolution            \n  0 calls (limit 30)                      Peak was 1 calls, after 0 s\n  0 Running, 3 Paused, 0 Woken up\n  0 dead call msg (discarded)             0 out-of-call msg (discarded)\n  0 open sockets                          0/0/0 TCP errors (send/recv/cong)\n\n                                 Messages  Retrans   Timeout   Unexpected-Msg\n      INVITE ---------->         1         0         0                         \n         180 &lt;----------         1         0         0         0               \n         200 &lt;----------  E-RTD1 1         0         0         0               \n         ACK ---------->         1         0                                   \n         BYE &lt;----------         1         0         0         0               \n         200 ---------->         1         0                                   \n------- Waiting for active calls to end. Press [q] again to force exit. -------\n----------------------------- Statistics Screen ------- [1-9]: Change Screen --\n  Start Time             | 2021-06-16\t17:45:29.353922\t1625237129.353922         \n  Last Reset Time        | 2021-06-16\t17:45:35.591290\t1625237135.591290         \n  Current Time           | 2021-06-16\t17:45:35.591325\t1625237135.591325         \n-------------------------+---------------------------+--------------------------\n  Incoming calls created |        0                  |        0                 \n  Outgoing calls created |        0                  |        1                 \n  Total Calls created    |                           |        1                 \n-------------------------+---------------------------+--------------------------\n  Successful call        |        0                  |        1                 \n  Failed call            |        0                  |        0                 \n-------------------------+---------------------------+--------------------------\n  Response Time 1        | 00:00:00:000000           | 00:00:00:000000          \n  Call Length            | 00:00:00:000000           | 00:00:00:000000          \n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>And if you still donâ€™t believe it works, you can run <a href=\"https://www.wireshark.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">wireshark</a>\nwith a <code class=\"language-text\">sip</code> filter before the test and check the captured packets.</p>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>In the above article I showed you how to create a SIP proxy service based on a <a href=\"https://www.sipstack.io/getstarted/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sipstack</a> library and <a href=\"https://netty.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">netty</a> server.\nThis example is very simple and not entirely correct (more on that below), so I would rather not use it in serious systems ðŸ˜Š.\nAfter all, during the writing of this article, I learned a lot and I hope that you will also find it useful.</p>\n<p>I remind you that all the code can be found <a href=\"https://github.com/kkdrz/blog-examples/tree/main/sip-proxy-with-netty\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">on my github</a>.</p>\n<h3 id=\"what-can-be-improved\" style=\"position:relative;\"><a href=\"#what-can-be-improved\" aria-label=\"what can be improved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What can be improved</h3>\n<h4 id=\"the-routing-logic\" style=\"position:relative;\"><a href=\"#the-routing-logic\" aria-label=\"the routing logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The routing logic</h4>\n<p>The solution I have presented is not entirely compatible with how the SIP protocol works.\nIn fact, requests (<code class=\"language-text\">INVITE</code>, <code class=\"language-text\">ACK</code>, <code class=\"language-text\">BYE</code>) can be based on the <code class=\"language-text\">Route</code> header,\nbut after receiving such a message, the server should add the <code class=\"language-text\">Via</code> header with its address.\nThe <code class=\"language-text\">Via</code> headers are used for responses to find their way back the exact same path as the request took.\nSo each element in the network that processed this request should add itâ€™s <code class=\"language-text\">Via</code> header (sometimes there are exceptions to this rule).</p>\n<p>So when the server receives a response, it should check if itâ€™s address is in the latest <code class=\"language-text\">Via</code> header.\nThen it should delete this header and forward the message to the address that it found in the next <code class=\"language-text\">Via</code> header.</p>","frontmatter":{"title":"SIP proxy server with Netty and SipStack","date":"15 June 2021","description":null,"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHdR1LCA//EABoQAAICAwAAAAAAAAAAAAAAAAABAhEQISL/2gAIAQEAAQUClZ1ihRoWl//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAIBBQAAAAAAAAAAAAAAABAxAAERIUFR/9oACAEBAAY/AsR0fC9WH//EABsQAQEAAwADAAAAAAAAAAAAAAERACFBEFGh/9oACAEBAAE/IdBYN6cy1w+HhtWykxFtvswQLZn/2gAMAwEAAgADAAAAEBPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAEEAwEAAAAAAAAAAAAAAREAITFBEGGhkf/aAAgBAQABPxBmwgrJ23RDmIlPiZz35wwzsUazepQPCAIe7GfKndQBLuv/2Q=="},"images":{"fallback":{"src":"/static/f7ce6b53d9404a990a7fe9291d72c140/f3fc5/featured.jpg","srcSet":"/static/f7ce6b53d9404a990a7fe9291d72c140/7284f/featured.jpg 750w,\n/static/f7ce6b53d9404a990a7fe9291d72c140/f3fc5/featured.jpg 898w","sizes":"100vw"},"sources":[{"srcSet":"/static/f7ce6b53d9404a990a7fe9291d72c140/b0356/featured.avif 750w,\n/static/f7ce6b53d9404a990a7fe9291d72c140/048e5/featured.avif 898w","type":"image/avif","sizes":"100vw"},{"srcSet":"/static/f7ce6b53d9404a990a7fe9291d72c140/57584/featured.webp 750w,\n/static/f7ce6b53d9404a990a7fe9291d72c140/9c270/featured.webp 898w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6670378619153675}}}}},"previous":{"excerpt":"Have you ever written code that you felt could be generated without any problems?\nIt happened to me many times. Thatâ€™s why I decided to share my experience withâ€¦","fields":{"slug":"/custom-annotation-processor/"},"frontmatter":{"date":"11 May 2021","title":"Custom Annotation Processor","description":null,"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAgX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHtLomNDg//xAAaEAADAAMBAAAAAAAAAAAAAAABAgMABBES/9oACAEBAAEFAiOtavgRYmfMfXSjqoUf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHRAAAgIBBQAAAAAAAAAAAAAAAAECERASIjEyYf/aAAgBAQAGPwJFLs+Ba3uwpSt+FJH/xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhQTFR/9oACAEBAAE/IWQLnLYD+FiPVnUbdqMXR9ZKegn/2gAMAwEAAgADAAAAEMAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBYXGB8f/aAAgBAQABPxAqbqDe8NPuMwORIW6HxARWpUCm+saqagh1Km1oX1hAz4J//9k="},"images":{"fallback":{"src":"/static/b4f15350cd052a82cd4210a5938ef13e/5267c/featured.jpg","srcSet":"/static/b4f15350cd052a82cd4210a5938ef13e/7284f/featured.jpg 750w,\n/static/b4f15350cd052a82cd4210a5938ef13e/29ba9/featured.jpg 1080w,\n/static/b4f15350cd052a82cd4210a5938ef13e/c8896/featured.jpg 1366w,\n/static/b4f15350cd052a82cd4210a5938ef13e/5267c/featured.jpg 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/b4f15350cd052a82cd4210a5938ef13e/b0356/featured.avif 750w,\n/static/b4f15350cd052a82cd4210a5938ef13e/48f75/featured.avif 1080w,\n/static/b4f15350cd052a82cd4210a5938ef13e/a5094/featured.avif 1366w,\n/static/b4f15350cd052a82cd4210a5938ef13e/f46cf/featured.avif 1920w","type":"image/avif","sizes":"100vw"},{"srcSet":"/static/b4f15350cd052a82cd4210a5938ef13e/57584/featured.webp 750w,\n/static/b4f15350cd052a82cd4210a5938ef13e/984df/featured.webp 1080w,\n/static/b4f15350cd052a82cd4210a5938ef13e/4a276/featured.webp 1366w,\n/static/b4f15350cd052a82cd4210a5938ef13e/9c00f/featured.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}}}},"next":{"excerpt":"Recently, interesting maps of Poland have been circulating on the Internet showing the occurrence of localities ending with various phrases (I have placed itâ€¦","fields":{"slug":"/map-of-localities-matching-the-pattern/"},"frontmatter":{"date":"11 July 2021","title":"A Map of Localities Matching the Pattern","description":null,"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACIklEQVQ4y32T22sTURDG94/zwaf6JEW0Dwq+tCDGC6VKoIrQihZC7UOrKAZEUCxiQYTe8ILVitKQik129yRNk6ppLpvsZpNmN7s/2U03jYn2g8OcMzDffHNmRnJdFw+e9Y/TIvAFcFstXMdp2+Duna7YAFKvI4CtFbG/vMUt5TkKvaRSx+FlLBdwNtbYf3IP49YFaqFBGjPj1FdeUZ9/RPNlFOvNc2qfVjHXlmnVjH6FwcMydIy7o5ihQbSpa5TmJjEmQpQjYWpXTmOMncW4eoZSJEzhwR0KU9fRY+uHYnoV2qaBNnOT8uwE+ReP0abHaY6coHZjmMblU+xfPEljdIhidJpqJEx5bpL8s4dYeuX/JRd+xMkuLlCdGqM5MoB97hjW+eM0QoPok5eojw75yncXF/g1H6W0+hq72fyrqQdNcXynUciTebdE8ekszeEBSvdvk32/RObrZ4QQpDdjpOMbCFVFVWRycoKWe9gcN1DYKduy2FZkZFlmd2mB3Idl1J2cTyBUpW3lJEJRECKF+n0TUysfluwp7MzfAamh6+zuZPxgJbGFSCbbREK0rUfmEwpUOcm2qtKy7Q6pdHDrab+Llv9NsVhkJ51CkWWER+6TyZ0EajLJ3t4eTle81C23+y8COI5DRdPIxr6RWf9IKh5DpFLIiS1+5nJ9Ay51O/rWsGtgvbJMQ6dumli2TbVSoVKt9m2LdNQquT2J/rF4fav3B88RwGMRH+wiAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/76883c8778b65beea60b27f713e13503/97cbe/featured.png","srcSet":"/static/76883c8778b65beea60b27f713e13503/97cbe/featured.png 743w","sizes":"100vw"},"sources":[{"srcSet":"/static/76883c8778b65beea60b27f713e13503/87885/featured.avif 743w","type":"image/avif","sizes":"100vw"},{"srcSet":"/static/76883c8778b65beea60b27f713e13503/bf206/featured.webp 743w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6648721399730821}}}}}},"pageContext":{"id":"c6e0574b-e7d1-5aa1-9adb-1f84dbd11404","previousPostId":"2159c8f3-f569-5685-be5d-e68b5a3bb21a","nextPostId":"79fba1df-4db6-5422-9b8a-bb842be35784"}},"staticQueryHashes":["2426997508","3000541721"]}